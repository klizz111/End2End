<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End2End</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea, button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .chat-container {
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto;
            background-color: #f8f9fa;
            margin-bottom: 10px;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .message.sent {
            background-color: #007bff;
            color: white;
            text-align: right;
        }
        .message.received {
            background-color: #e9ecef;
            color: #333;
        }
        .flex-container {
            display: flex;
            gap: 20px;
        }
        .flex-item {
            flex: 1;
        }
        .error {
            color: #dc3545;
            margin: 10px 0;
        }
        .success {
            color: #28a745;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>End2End</h1>
    
    <div class="container">
        <h2>系统状态</h2>
        <div id="status" class="status disconnected">
            状态: 未连接 | 模式: 未设置
        </div>
        <button onclick="updateStatus()">刷新状态</button>
    </div>

    <div class="flex-container">
        <div class="flex-item">
            <div class="container">
                <h2>服务器配置</h2>
                <div class="form-group">
                    <label for="mode">运行模式:</label>
                    <select id="mode">
                        <option value="">请选择模式</option>
                        <option value="server">服务器模式</option>
                        <option value="client">客户端模式</option>
                    </select>
                </div>
                
                <div id="client-config" style="display: none;">
                    <div class="form-group">
                        <label for="host">目标主机:</label>
                        <input type="text" id="host" value="localhost" placeholder="localhost">
                    </div>
                    <div class="form-group">
                        <label for="port">目标端口:</label>
                        <input type="number" id="port" value="8848" placeholder="8848">
                    </div>
                </div>
                
                <button onclick="configureSetting()">应用配置</button>
                <div id="config-result"></div>
            </div>
        </div>

        <div class="flex-item">
            <div class="container">
                <h2>加密聊天</h2>
                <div id="chat-container" class="chat-container">
                    <div class="message received">系统: 等待连接建立...</div>
                </div>
                
                <div class="form-group">
                    <textarea id="message-input" rows="3" placeholder="输入消息..." disabled></textarea>
                </div>
                
                <button onclick="sendMessage()" id="send-btn" disabled>发送消息</button>
                <button onclick="receiveMessages()" id="receive-btn" disabled>接收消息</button>
                
                <div id="chat-result"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>系统日志</h2>
        <div id="log-container" class="chat-container">
            <div class="message received">系统启动...</div>
        </div>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <script>
        let currentMode = '';
        let isConnected = false;

        // 页面加载时更新状态
        window.onload = function() {
            updateStatus();
            
            // 定期更新状态
            setInterval(updateStatus, 3000);
            
            // 定期接收消息
            setInterval(receiveMessages, 2000);
        };

        // 模式选择改变时显示/隐藏客户端配置
        document.getElementById('mode').onchange = function() {
            const mode = this.value;
            const clientConfig = document.getElementById('client-config');
            if (mode === 'client') {
                clientConfig.style.display = 'block';
            } else {
                clientConfig.style.display = 'none';
            }
        };

        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message received';
            messageDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(messageDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = isError ? 'error' : 'success';
            setTimeout(() => {
                element.innerHTML = '';
                element.className = '';
            }, 5000);
        }

        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('status');
                    const status = data.status;
                    const mode = data.mode;
                    const apiPort = data.api_port;
                    const listenPort = data.listen_port;
                    
                    let statusText = '';
                    let statusClass = '';
                    
                    switch (status) {
                        case 'connected':
                            statusText = '已连接';
                            statusClass = 'connected';
                            isConnected = true;
                            break;
                        case 'connecting':
                            statusText = '连接中';
                            statusClass = 'connecting';
                            isConnected = false;
                            break;
                        case 'key_exchange':
                            statusText = '密钥交换中';
                            statusClass = 'connecting';
                            isConnected = false;
                            break;
                        default:
                            statusText = '未连接';
                            statusClass = 'disconnected';
                            isConnected = false;
                    }
                    
                    currentMode = mode;
                    let modeText = mode === 'none' ? '未设置' : mode === 'server' ? '服务器' : '客户端';
                    let portInfo = apiPort ? ` | API端口: ${apiPort}` : '';
                    if (mode === 'server' && listenPort) {
                        portInfo += ` | 监听端口: ${listenPort}`;
                    }
                    
                    statusElement.textContent = `状态: ${statusText} | 模式: ${modeText}${portInfo}`;
                    statusElement.className = `status ${statusClass}`;
                    
                    // 更新聊天按钮状态
                    const sendBtn = document.getElementById('send-btn');
                    const receiveBtn = document.getElementById('receive-btn');
                    const messageInput = document.getElementById('message-input');
                    
                    if (isConnected) {
                        sendBtn.disabled = false;
                        receiveBtn.disabled = false;
                        messageInput.disabled = false;
                    } else {
                        sendBtn.disabled = true;
                        receiveBtn.disabled = true;
                        messageInput.disabled = true;
                    }
                })
                .catch(error => {
                    log('更新状态失败: ' + error.message, 'error');
                });
        }

        function configureSetting() {
            const mode = document.getElementById('mode').value;
            if (!mode) {
                showResult('config-result', '请选择运行模式', true);
                return;
            }

            const setting = { mode: mode };
            
            if (mode === 'client') {
                const host = document.getElementById('host').value;
                const port = parseInt(document.getElementById('port').value);
                
                if (!host || !port) {
                    showResult('config-result', '请填写完整的目标服务器信息', true);
                    return;
                }
                
                setting.destination = { host: host, port: port };
            }

            fetch('/setting', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(setting)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResult('config-result', '配置成功!');
                    log(`配置为${mode}模式`);
                    setTimeout(updateStatus, 1000);
                } else {
                    showResult('config-result', '配置失败: ' + (data.error || '未知错误'), true);
                }
            })
            .catch(error => {
                showResult('config-result', '配置失败: ' + error.message, true);
                log('配置失败: ' + error.message, 'error');
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) {
                showResult('chat-result', '请输入消息内容', true);
                return;
            }

            fetch('/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 添加到聊天界面
                    addChatMessage(message, true);
                    messageInput.value = '';
                    showResult('chat-result', '消息发送成功!');
                    log(`发送消息: ${message}`);
                } else {
                    showResult('chat-result', '发送失败: ' + (data.error || '未知错误'), true);
                }
            })
            .catch(error => {
                showResult('chat-result', '发送失败: ' + error.message, true);
                log('发送消息失败: ' + error.message, 'error');
            });
        }

        function receiveMessages() {
            if (!isConnected) return;
            
            fetch('/chat/messages')
                .then(response => response.json())
                .then(messages => {
                    if (Array.isArray(messages) && messages.length > 0) {
                        messages.forEach(encryptedMessage => {
                            // 解密消息
                            fetch('/chat/receive', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ encrypted_message: encryptedMessage })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.message) {
                                    addChatMessage(data.message, false);
                                    log(`收到消息: ${data.message}`);
                                }
                            })
                            .catch(error => {
                                log('解密消息失败: ' + error.message, 'error');
                            });
                        });
                    }
                })
                .catch(error => {
                    // 静默处理，避免频繁错误日志
                });
        }

        function addChatMessage(message, isSent) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            messageDiv.textContent = `${isSent ? '我' : '对方'}: ${message}`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function clearLog() {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = '<div class="message received">日志已清空</div>';
        }

        // 回车发送消息
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>