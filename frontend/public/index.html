<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End2End</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --border-color: #ddd;
            --input-bg: white;
            --chat-bg: #f8f9fa;
            --message-received-bg: #e9ecef;
            --shadow: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #555;
            --input-bg: #3d3d3d;
            --chat-bg: #2a2a2a;
            --message-received-bg: #404040;
            --shadow: rgba(0,0,0,0.3);
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 4px var(--shadow);
            z-index: 1000;
        }
        
        .container {
            background: var(--container-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        h1, h2 {
            color: var(--text-color);
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }
        
        input, select, textarea, button {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin: 5px 0;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .chat-container {
            height: 300px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto;
            background-color: var(--chat-bg);
            margin-bottom: 10px;
        }
        
        .message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .message.sent {
            background-color: #007bff;
            color: white;
            text-align: right;
        }
        .message.received {
            background-color: var(--message-received-bg);
            color: var(--text-color);
        }
        .message.system {
            background-color: #17a2b8;
            color: white;
            text-align: center;
            font-style: italic;
        }
        
        .flex-container {
            display: flex;
            gap: 20px;
        }
        .flex-item {
            flex: 1;
        }
        
        .error {
            color: #dc3545;
            margin: 10px 0;
        }
        .success {
            color: #28a745;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .flex-container {
                flex-direction: column;
            }
            body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼">
        ğŸŒ™
    </div>
    
    <h1>End2End</h1>
    
    <div class="container">
        <h2>ç³»ç»ŸçŠ¶æ€</h2>
        <div id="status" class="status disconnected">
            çŠ¶æ€: æœªè¿æ¥ | æ¨¡å¼: æœªè®¾ç½®
        </div>
        <button onclick="updateStatus()">åˆ·æ–°çŠ¶æ€</button>
    </div>

    <div class="flex-container">
        <div class="flex-item">
            <div class="container">
                <h2>æœåŠ¡å™¨é…ç½®</h2>
                <div class="form-group">
                    <label for="mode">è¿è¡Œæ¨¡å¼:</label>
                    <select id="mode">
                        <option value="">è¯·é€‰æ‹©æ¨¡å¼</option>
                        <option value="server">æœåŠ¡å™¨æ¨¡å¼</option>
                        <option value="client">å®¢æˆ·ç«¯æ¨¡å¼</option>
                    </select>
                </div>
                
                <div id="client-config" style="display: none;">
                    <div class="form-group">
                        <label for="host">ç›®æ ‡ä¸»æœº:</label>
                        <input type="text" id="host" value="localhost" placeholder="localhost">
                    </div>
                    <div class="form-group">
                        <label for="port">ç›®æ ‡ç«¯å£:</label>
                        <input type="number" id="port" value="8848" placeholder="8848">
                    </div>
                </div>
                
                <button onclick="configureSetting()">åº”ç”¨é…ç½®</button>
                <div id="config-result"></div>
            </div>
        </div>

        <div class="flex-item">
            <div class="container">
                <h2>åŠ å¯†èŠå¤©</h2>
                <div id="chat-container" class="chat-container">
                    <div class="message system" id="system-message">ç³»ç»Ÿ: ç­‰å¾…è¿æ¥å»ºç«‹...</div>
                </div>
                
                <div class="form-group">
                    <textarea id="message-input" rows="3" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled></textarea>
                </div>
                
                <button onclick="sendMessage()" id="send-btn" disabled>å‘é€æ¶ˆæ¯</button>
                
                <div id="chat-result"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ç³»ç»Ÿæ—¥å¿—</h2>
        <div id="log-container" class="chat-container">
            <div class="message received">ç³»ç»Ÿå¯åŠ¨...</div>
        </div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        let currentMode = '';
        let isConnected = false;
        let processedMessages = new Set(); // ç”¨äºè¿½è¸ªå·²å¤„ç†çš„æ¶ˆæ¯ï¼Œé¿å…é‡å¤æ˜¾ç¤º

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°çŠ¶æ€
        window.onload = function() {
            updateStatus();
            
            // å®šæœŸæ›´æ–°çŠ¶æ€
            setInterval(updateStatus, 3000);
            
            // å®šæœŸæ¥æ”¶æ¶ˆæ¯
            setInterval(receiveMessages, 2000);
        };

        // æ¨¡å¼é€‰æ‹©æ”¹å˜æ—¶æ˜¾ç¤º/éšè—å®¢æˆ·ç«¯é…ç½®
        document.getElementById('mode').onchange = function() {
            const mode = this.value;
            const clientConfig = document.getElementById('client-config');
            if (mode === 'client') {
                clientConfig.style.display = 'block';
            } else {
                clientConfig.style.display = 'none';
            }
        };

        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message received';
            messageDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(messageDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = isError ? 'error' : 'success';
            setTimeout(() => {
                element.innerHTML = '';
                element.className = '';
            }, 5000);
        }

        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('status');
                    const systemMessage = document.getElementById('system-message');
                    const coreStatus = data.core_status;
                    const port = data.port;
                    
                    let statusText = '';
                    let statusClass = '';
                    
                    if (coreStatus === 'connected') {
                        statusText = 'å·²è¿æ¥';
                        statusClass = 'connected';
                        isConnected = true;
                        
                        // éšè—ç³»ç»Ÿç­‰å¾…æ¶ˆæ¯
                        if (systemMessage) {
                            systemMessage.style.display = 'none';
                        }
                    } else {
                        statusText = 'æœªè¿æ¥';
                        statusClass = 'disconnected';
                        isConnected = false;
                        
                        // æ˜¾ç¤ºç³»ç»Ÿç­‰å¾…æ¶ˆæ¯
                        if (systemMessage) {
                            systemMessage.style.display = 'block';
                            systemMessage.textContent = 'ç³»ç»Ÿ: ç­‰å¾…è¿æ¥å»ºç«‹...';
                        }
                    }
                    
                    statusElement.textContent = `çŠ¶æ€: ${statusText} | Webç«¯å£: ${port}`;
                    statusElement.className = `status ${statusClass}`;
                    
                    // æ›´æ–°èŠå¤©æŒ‰é’®çŠ¶æ€
                    const sendBtn = document.getElementById('send-btn');
                    const messageInput = document.getElementById('message-input');
                    
                    if (isConnected) {
                        sendBtn.disabled = false;
                        messageInput.disabled = false;
                    } else {
                        sendBtn.disabled = true;
                        messageInput.disabled = true;
                    }
                })
                .catch(error => {
                    log('æ›´æ–°çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
                    const statusElement = document.getElementById('status');
                    statusElement.textContent = 'çŠ¶æ€: è¿æ¥é”™è¯¯';
                    statusElement.className = 'status disconnected';
                });
        }

        function configureSetting() {
            const mode = document.getElementById('mode').value;
            if (!mode) {
                showResult('config-result', 'è¯·é€‰æ‹©è¿è¡Œæ¨¡å¼', true);
                return;
            }

            const setting = { mode: mode };
            
            if (mode === 'client') {
                const host = document.getElementById('host').value;
                const port = parseInt(document.getElementById('port').value);
                
                if (!host || !port) {
                    showResult('config-result', 'è¯·å¡«å†™å®Œæ•´çš„ç›®æ ‡æœåŠ¡å™¨ä¿¡æ¯', true);
                    return;
                }
                
                setting.ip = host;
                setting.port = port;
            }

            fetch('/api/setting', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(setting)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResult('config-result', data.message || 'é…ç½®æˆåŠŸ!');
                    log(`é…ç½®ä¸º${mode}æ¨¡å¼`);
                    setTimeout(updateStatus, 1000);
                    
                    // æ¸…ç©ºå·²å¤„ç†æ¶ˆæ¯è®°å½•ï¼Œé‡æ–°å¼€å§‹
                    processedMessages.clear();
                } else {
                    showResult('config-result', 'é…ç½®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
                }
            })
            .catch(error => {
                showResult('config-result', 'é…ç½®å¤±è´¥: ' + error.message, true);
                log('é…ç½®å¤±è´¥: ' + error.message, 'error');
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) {
                showResult('chat-result', 'è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', true);
                return;
            }

            fetch('/api/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ·»åŠ åˆ°èŠå¤©ç•Œé¢
                    addChatMessage(message, true);
                    messageInput.value = '';
                    showResult('chat-result', 'æ¶ˆæ¯å‘é€æˆåŠŸ!');
                    log(`å‘é€æ¶ˆæ¯: ${message}`);
                    
                    // è®°å½•å·²å‘é€çš„æ¶ˆæ¯ï¼Œé¿å…é‡å¤æ˜¾ç¤º
                    processedMessages.add(message);
                } else {
                    showResult('chat-result', 'å‘é€å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
                }
            })
            .catch(error => {
                showResult('chat-result', 'å‘é€å¤±è´¥: ' + error.message, true);
                log('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
            });
        }

        function receiveMessages() {
            fetch('/api/messages')
                .then(response => response.json())
                .then(data => {
                    if (data.messages && Array.isArray(data.messages) && data.messages.length > 0) {
                        data.messages.forEach(message => {
                            // åªæ˜¾ç¤ºæœªå¤„ç†è¿‡çš„æ¶ˆæ¯
                            if (!processedMessages.has(message)) {
                                addChatMessage(message, false);
                                log(`æ”¶åˆ°æ¶ˆæ¯: ${message}`);
                                processedMessages.add(message);
                            }
                        });
                    }
                })
                .catch(error => {
                    // é™é»˜å¤„ç†ï¼Œé¿å…é¢‘ç¹é”™è¯¯æ—¥å¿—
                });
        }

        function addChatMessage(message, isSent) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            messageDiv.textContent = `${isSent ? 'æˆ‘' : 'å¯¹æ–¹'}: ${message}`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function clearLog() {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = '<div class="message received">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // æ·±è‰²æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (currentTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'light');
                themeToggle.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggle.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'dark');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¸»é¢˜è®¾ç½®
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggle.textContent = 'â˜€ï¸';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                themeToggle.textContent = 'ğŸŒ™';
            }
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        initTheme();
    </script>
</body>
</html>